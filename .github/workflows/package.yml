name: Package PWA Plugin

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: Release tag to package (for example v1.4.0)
        required: true
        type: string

permissions:
  contents: write

jobs:
  update-metadata:
    runs-on: ubuntu-latest
    env:
      DEFAULT_BRANCH: ${{ github.event.repository.default_branch || 'main' }}
    outputs:
      tag: ${{ steps.release.outputs.tag }}
      version: ${{ steps.release.outputs.version }}
      default_branch: ${{ env.DEFAULT_BRANCH }}
    steps:
      - name: Checkout default branch
        uses: actions/checkout@v4
        with:
          ref: ${{ env.DEFAULT_BRANCH }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Resolve release version
        id: release
        run: |
          TAG="${{ github.event.release.tag_name || inputs.tag }}"
          VERSION="${TAG#v}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Resolved tag: $TAG"
          echo "Resolved version: $VERSION"

      - name: Update plugin.json and update.json
        run: |
          REPO="${{ github.repository }}"
          TAG="${{ steps.release.outputs.tag }}"
          VERSION="${{ steps.release.outputs.version }}"
          DOWNLOAD_URL="https://github.com/$REPO/releases/download/$TAG/pwa-plugin.zip"

          jq --arg version "$VERSION" '.version = $version' plugin.json > plugin.json.tmp
          mv plugin.json.tmp plugin.json

          cat > update.json << EOF
          {
            "*": {
              "version": "$VERSION",
              "download_url": "$DOWNLOAD_URL"
            }
          }
          EOF

          echo "plugin.json version: $(jq -r '.version' plugin.json)"
          echo "update.json version: $(jq -r '.[\"*\"].version' update.json)"

      - name: Commit metadata changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add plugin.json update.json

          if git diff --staged --quiet; then
            echo "No metadata changes to commit"
          else
            git commit -m "Update release metadata to version ${{ steps.release.outputs.version }}"
            git pull --rebase origin "${DEFAULT_BRANCH}"
            git push origin "HEAD:${DEFAULT_BRANCH}"
          fi

  package:
    runs-on: ubuntu-latest
    needs: update-metadata
    env:
      DEFAULT_BRANCH: ${{ needs.update-metadata.outputs.default_branch }}
      RELEASE_TAG: ${{ needs.update-metadata.outputs.tag }}
      RELEASE_VERSION: ${{ needs.update-metadata.outputs.version }}
    steps:
      - name: Checkout updated default branch
        uses: actions/checkout@v4
        with:
          ref: ${{ env.DEFAULT_BRANCH }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Force release versions before packaging
        run: |
          REPO="${{ github.repository }}"
          TAG="${RELEASE_TAG}"
          VERSION="${RELEASE_VERSION}"
          DOWNLOAD_URL="https://github.com/$REPO/releases/download/$TAG/pwa-plugin.zip"

          jq --arg version "$VERSION" '.version = $version' plugin.json > plugin.json.tmp
          mv plugin.json.tmp plugin.json

          cat > update.json << EOF
          {
            "*": {
              "version": "$VERSION",
              "download_url": "$DOWNLOAD_URL"
            }
          }
          EOF

          echo "Packaging version: $(jq -r '.version' plugin.json)"
          echo "Update manifest version: $(jq -r '.[\"*\"].version' update.json)"

      - name: Create pwa-plugin directory structure
        run: |
          mkdir -p pwa-plugin
          rsync -av --exclude='.git' --exclude='pwa-plugin' ./ pwa-plugin/

      - name: Create zip archive
        run: zip -r pwa-plugin.zip pwa-plugin/

      - name: Verify package archive
        run: ls -lah pwa-plugin.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pwa-plugin
          path: pwa-plugin.zip

      - name: Upload asset to release
        if: github.event_name == 'release'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./pwa-plugin.zip
          asset_name: pwa-plugin.zip
          asset_content_type: application/zip
